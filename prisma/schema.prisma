// Zoptymalizowany schemat bazy danych dla AliMatrix
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model EmailSubscription {
  id                String           @id @default(cuid())
  email             String           @unique
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  submittedAt       DateTime?
  acceptedTerms     Boolean          @default(false)
  acceptedContact   Boolean          @default(false)
  status            String           @default("pending") // pending, verified, submitted
  verificationToken String?
  verifiedAt        DateTime?
  formSubmissions   FormSubmission[]

  @@index([status])
}

model FormSubmission {
  id                  String            @id @default(cuid())
  emailSubscriptionId String
  emailSubscription   EmailSubscription @relation(fields: [emailSubscriptionId], references: [id])
  formData            Json // Pełne dane formularza w JSON
  submittedAt         DateTime          @default(now())
  processedAt         DateTime?
  status              String            @default("pending") // pending, processed
  reportUrl           String?

  // Główne informacje o formularzu
  sciezkaWybor        String? // established, not-established
  podstawaUstalen     String? // postanowienie-zabezpieczajace, wyrok-rozwodowy, porozumienie-sad, porozumienie-mediacja, porozumienie-prywatne, inne
  podstawaUstalenInne String? // Szczegóły dla opcji "inne"
  wariantPostepu      String? // court, agreement, other
  sposobFinansowania  String? // i-pay, i-receive, shared

  // Dane demograficzne
  plecUzytkownika            String?
  wiekUzytkownika            String?
  wojewodztwoUzytkownika     String?
  miejscowoscUzytkownika     String?
  stanCywilnyUzytkownika     String?
  plecDrugiegoRodzica        String?
  wiekDrugiegoRodzica        String?
  wojewodztwoDrugiegoRodzica String?
  miejscowoscDrugiegoRodzica String?
  // Dane sądowe
  rodzajSaduSad              String? // rejonowy, okregowy, nie_pamietam
  apelacjaSad                String? // ID apelacji (kompatybilność wsteczna)
  apelacjaId                 String? // ID apelacji 
  apelacjaNazwa              String? // Nazwa apelacji
  sadOkregowyId              String? // ID sądu okręgowego
  sadOkregowyNazwa           String? // Nazwa sądu okręgowego
  sadRejonowyId              String? // ID sądu rejonowego
  sadRejonowyNazwa           String? // Nazwa sądu rejonowego
  rokDecyzjiSad              String? // Rok decyzji sądu
  miesiacDecyzjiSad          String? // Miesiąc decyzji sądu
  dataDecyzjiSad             String? // Pełna data decyzji
  liczbaSedzi                String? // jeden, trzech
  plecSedziego               String? // kobieta, mezczyzna
  inicjalySedziego           String? // Inicjały sędziego
  czyPozew                   String? // tak, nie
  watekWiny                  String? // nie, tak-ja, tak-druga-strona, tak-oboje

  // Dane porozumienia
  dataPorozumienia      String?
  sposobPorozumienia    String?
  formaPorozumienia     String?
  klauzulaWaloryzacyjna String?

  // Dane ustaleń innych
  dataUstalenInnych       String?
  uzgodnienieFinansowania String?
  planyWystapieniaDoSadu  String?

  // Oceny adekwatności
  ocenaAdekwatnosciSad          Float?
  ocenaAdekwatnosciPorozumienie Float?
  ocenaAdekwatnosciInne         Float?

  // Powiązane dane
  liczbaDzieci    Int?
  dzieci          Child[] // Relacja z dziećmi
  dochodyRodzicow Dochody? // Relacja z dochodami

  @@index([status])
  @@index([emailSubscriptionId])
  @@index([rodzajSaduSad])
  @@index([apelacjaSad])
  @@index([apelacjaId])
  @@index([sadOkregowyId])
  @@index([sadRejonowyId])
  @@index([rokDecyzjiSad])
  @@index([sposobFinansowania])
  @@index([podstawaUstalen])
}

// Model dziecka
model Child {
  id                     String         @id @default(cuid())
  formSubmissionId       String
  formSubmission         FormSubmission @relation(fields: [formSubmissionId], references: [id], onDelete: Cascade)
  childId                Int // ID dziecka w obrębie formularza (1, 2, 3, ...)
  wiek                   Int?
  plec                   String? // K, M, I
  specjalnePotrzeby      Boolean        @default(false)
  opisSpecjalnychPotrzeb String?
  uczeszczeDoPlacowki    Boolean?
  typPlacowki            String? // zlobek, przedszkole, podstawowa, ponadpodstawowa
  opiekaInnejOsoby       Boolean?
  modelOpieki            String? // 50/50, inny
  cyklOpieki             String? // 1, 2, 4, custom
  procentCzasuOpieki     Float?

  // Dane o kosztach utrzymania dziecka
  kwotaAlimentow         Float?
  twojeMiesieczneWydatki Float?
  wydatkiDrugiegoRodzica Float?
  kosztyUznanePrzezSad   Float?

  // Inne źródła utrzymania dziecka
  rentaRodzinna                 Boolean @default(false)
  rentaRodzinnaKwota            Float?
  swiadczeniePielegnacyjne      Boolean @default(false)
  swiadczeniePielegnacyjneKwota Float?
  inneZrodla                    Boolean @default(false)
  inneZrodlaOpis                String?
  inneZrodlaKwota               Float?
  brakDodatkowychZrodel         Boolean @default(true)

  // Dane o czasie opieki
  tabelaCzasu            Json? // Szczegółowe dane o tabeli czasu w formacie JSON
  wskaznikiCzasuOpieki   Json? // Wskaźniki czasu opieki w formacie JSON
  wakacjeProcentCzasu    Float?
  wakacjeSzczegolowyPlan Boolean @default(false)
  wakacjeOpisPlan        String?

  @@unique([formSubmissionId, childId])
  @@index([formSubmissionId])
}

// Model dochodów rodziców
model Dochody {
  id               String         @id @default(cuid())
  formSubmissionId String         @unique
  formSubmission   FormSubmission @relation(fields: [formSubmissionId], references: [id], onDelete: Cascade)

  // Dochody wypełniającego
  wlasneDochodyNetto          Float?
  wlasnePotencjalDochodowy    Float?
  wlasneKosztyUtrzymania      Float?
  wlasneKosztyInni            Float?
  wlasneDodatkoweZobowiazania Float?

  // Dochody drugiego rodzica
  drugiRodzicDochody    Float?
  drugiRodzicPotencjal  Float?
  drugiRodzicKoszty     Float?
  drugiRodzicKosztyInni Float?
  drugiRodzicDodatkowe  Float?
}
